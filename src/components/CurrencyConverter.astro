---
/**
 * CurrencyConverter.astro
 *
 * Quick USD to INR converter with live rates from exchangerate-api.
 * Falls back to approximate rate if API fails.
 */

// Approximate rate (will be updated client-side with live rate)
const fallbackRate = 83.5;
---

<div class="converter-card">
  <div class="converter-header">
    <h3 class="converter-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="16"></line>
        <line x1="8" y1="12" x2="16" y2="12"></line>
      </svg>
      Currency Converter
    </h3>
    <div class="rate-display">
      <span class="rate-label">Live Rate:</span>
      <span class="rate-value" id="live-rate">$1 = â‚¹{fallbackRate}</span>
      <span class="rate-updated" id="rate-updated">Loading...</span>
    </div>
  </div>

  <div class="converter-body">
    <div class="input-group">
      <label class="input-label" for="usd-input">
        <span class="currency-flag">ðŸ‡ºðŸ‡¸</span>
        USD
      </label>
      <div class="input-wrapper">
        <span class="input-prefix">$</span>
        <input
          type="number"
          id="usd-input"
          class="currency-input"
          placeholder="0.00"
          step="0.01"
          min="0"
        />
      </div>
    </div>

    <button class="swap-button" id="swap-btn" aria-label="Swap currencies">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="17 1 21 5 17 9"></polyline>
        <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
        <polyline points="7 23 3 19 7 15"></polyline>
        <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
      </svg>
    </button>

    <div class="input-group">
      <label class="input-label" for="inr-input">
        <span class="currency-flag">ðŸ‡®ðŸ‡³</span>
        INR
      </label>
      <div class="input-wrapper">
        <span class="input-prefix">â‚¹</span>
        <input
          type="number"
          id="inr-input"
          class="currency-input"
          placeholder="0.00"
          step="1"
          min="0"
        />
      </div>
    </div>
  </div>

  <div class="quick-amounts">
    <span class="quick-label">Quick convert:</span>
    <div class="quick-buttons">
      <button class="quick-btn" data-usd="10">$10</button>
      <button class="quick-btn" data-usd="20">$20</button>
      <button class="quick-btn" data-usd="50">$50</button>
      <button class="quick-btn" data-usd="100">$100</button>
      <button class="quick-btn" data-usd="500">$500</button>
    </div>
  </div>

  <div class="converter-tips">
    <h4 class="tips-heading">Money Tips for India</h4>
    <ul class="tips-list">
      <li><strong>ATMs:</strong> Withdraw INR at airport or city ATMs (lower fees than exchange)</li>
      <li><strong>Cards:</strong> Visa/Mastercard widely accepted at malls & restaurants</li>
      <li><strong>Cash:</strong> Carry cash for auto-rickshaws, street vendors, small shops</li>
      <li><strong>UPI:</strong> Google Pay/PhonePe very popular - works with international cards</li>
      <li><strong>Bargaining:</strong> Expected at markets - start at 50% of quoted price</li>
    </ul>
  </div>
</div>

<script define:vars={{ fallbackRate }}>
  let currentRate = fallbackRate;
  let lastDirection = 'usd'; // Track which input was last edited

  const usdInput = document.getElementById('usd-input');
  const inrInput = document.getElementById('inr-input');
  const rateDisplay = document.getElementById('live-rate');
  const rateUpdated = document.getElementById('rate-updated');
  const swapBtn = document.getElementById('swap-btn');
  const quickBtns = document.querySelectorAll('.quick-btn');

  // Fetch live exchange rate
  async function fetchRate() {
    try {
      const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
      const data = await response.json();
      if (data.rates && data.rates.INR) {
        currentRate = data.rates.INR;
        rateDisplay.textContent = `$1 = â‚¹${currentRate.toFixed(2)}`;
        rateUpdated.textContent = 'Updated just now';
        rateUpdated.classList.add('success');
      }
    } catch (error) {
      console.warn('Failed to fetch live rate, using fallback');
      rateUpdated.textContent = 'Using approximate rate';
      rateUpdated.classList.add('fallback');
    }
  }

  // Convert USD to INR
  function usdToInr(usd) {
    return (usd * currentRate).toFixed(2);
  }

  // Convert INR to USD
  function inrToUsd(inr) {
    return (inr / currentRate).toFixed(2);
  }

  // Handle USD input
  usdInput.addEventListener('input', () => {
    lastDirection = 'usd';
    const usd = parseFloat(usdInput.value) || 0;
    inrInput.value = usd > 0 ? usdToInr(usd) : '';
  });

  // Handle INR input
  inrInput.addEventListener('input', () => {
    lastDirection = 'inr';
    const inr = parseFloat(inrInput.value) || 0;
    usdInput.value = inr > 0 ? inrToUsd(inr) : '';
  });

  // Swap button
  swapBtn.addEventListener('click', () => {
    const usdVal = usdInput.value;
    const inrVal = inrInput.value;

    // Swap the values
    usdInput.value = inrVal ? inrToUsd(parseFloat(inrVal)) : '';
    inrInput.value = usdVal ? usdToInr(parseFloat(usdVal)) : '';

    // Animate the button
    swapBtn.classList.add('rotating');
    setTimeout(() => swapBtn.classList.remove('rotating'), 300);
  });

  // Quick amount buttons
  quickBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const usd = parseFloat(btn.dataset.usd);
      usdInput.value = usd;
      inrInput.value = usdToInr(usd);
      lastDirection = 'usd';

      // Highlight the clicked button
      quickBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // Fetch rate on load
  fetchRate();

  // Refresh rate every 5 minutes
  setInterval(fetchRate, 5 * 60 * 1000);
</script>

<style>
  .converter-card {
    background-color: var(--color-bg-card);
    border-radius: var(--radius-card);
    border: 1px solid var(--color-border);
    overflow: hidden;
  }

  .converter-header {
    padding: var(--spacing-4);
    background: linear-gradient(135deg, var(--color-gold-500) 0%, var(--color-gold-600) 100%);
    color: white;
  }

  .converter-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin: 0 0 var(--spacing-2) 0;
  }

  .rate-display {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--spacing-2);
  }

  .rate-label {
    font-size: var(--font-size-sm);
    opacity: 0.9;
  }

  .rate-value {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-bold);
  }

  .rate-updated {
    font-size: var(--font-size-xs);
    opacity: 0.8;
    padding: 2px 8px;
    background-color: rgba(255,255,255,0.2);
    border-radius: 10px;
  }

  .rate-updated.success {
    background-color: rgba(34, 197, 94, 0.3);
  }

  .rate-updated.fallback {
    background-color: rgba(251, 191, 36, 0.3);
  }

  .converter-body {
    padding: var(--spacing-4);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
    align-items: center;
  }

  @media (min-width: 640px) {
    .converter-body {
      flex-direction: row;
      gap: var(--spacing-4);
    }
  }

  .input-group {
    flex: 1;
    width: 100%;
  }

  .input-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-2);
  }

  .currency-flag {
    font-size: var(--font-size-lg);
  }

  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .input-prefix {
    position: absolute;
    left: var(--spacing-3);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-muted);
  }

  .currency-input {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-3) var(--spacing-3) var(--spacing-8);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-earth-900);
    background-color: var(--color-bg-secondary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-card);
    transition: all 0.2s ease;
  }

  .currency-input:focus {
    outline: none;
    border-color: var(--color-gold-500);
    box-shadow: 0 0 0 3px var(--color-gold-200);
  }

  .currency-input::placeholder {
    color: var(--color-text-muted);
    font-weight: var(--font-weight-normal);
  }

  /* Hide number input spinners */
  .currency-input::-webkit-outer-spin-button,
  .currency-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .currency-input[type=number] {
    -moz-appearance: textfield;
  }

  .swap-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background-color: var(--color-gold-100);
    border: 2px solid var(--color-gold-300);
    border-radius: 50%;
    color: var(--color-gold-700);
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .swap-button:hover {
    background-color: var(--color-gold-200);
    transform: scale(1.05);
  }

  .swap-button.rotating {
    transform: rotate(180deg);
  }

  .quick-amounts {
    padding: var(--spacing-3) var(--spacing-4);
    background-color: var(--color-bg-secondary);
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  .quick-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    display: block;
    margin-bottom: var(--spacing-2);
  }

  .quick-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
  }

  .quick-btn {
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    background-color: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-button);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quick-btn:hover {
    background-color: var(--color-gold-100);
    border-color: var(--color-gold-300);
    color: var(--color-gold-700);
  }

  .quick-btn.active {
    background-color: var(--color-gold-500);
    border-color: var(--color-gold-500);
    color: white;
  }

  .converter-tips {
    padding: var(--spacing-4);
  }

  .tips-heading {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-earth-900);
    margin: 0 0 var(--spacing-2) 0;
  }

  .tips-list {
    margin: 0;
    padding-left: var(--spacing-4);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
  }

  .tips-list li {
    margin-bottom: var(--spacing-2);
  }

  .tips-list strong {
    color: var(--color-earth-800);
  }
</style>
