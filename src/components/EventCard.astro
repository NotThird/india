---
/**
 * EventCard.astro
 *
 * Purpose: Display wedding event details within the itinerary timeline.
 *
 * Features:
 * - Event name and description
 * - Time display (start and optional end time)
 * - Venue and address (with TBC handling)
 * - Event type badge
 * - Mini-map showing venue location (when coordinates available)
 * - Get Directions buttons for Google Maps and Apple Maps
 * - Clickable address for quick navigation
 *
 * Props:
 * - event: WeddingEvent object from events.json
 * - showMap: boolean - Whether to show the mini-map (default: true)
 */

import Badge from "./Badge.astro";
import MiniMap from "./MiniMap.astro";
import type { WeddingEvent } from "../types/data";
import {
  generateGoogleMapsUrl,
  generateAppleMapsUrl,
  isValidCoordinates,
} from "../utils/deepLinks";

interface Props {
  event: WeddingEvent;
  showMap?: boolean;
}

const { event, showMap = true } = Astro.props;

// Format time for display (24h to 12h conversion)
function formatTime(time: string): string {
  const [hours, minutes] = time.split(":");
  const hour = parseInt(hours, 10);
  const ampm = hour >= 12 ? "PM" : "AM";
  const displayHour = hour % 12 || 12;
  return `${displayHour}:${minutes} ${ampm}`;
}

// Build time range string
function getTimeRange(startTime: string, endTime: string | null): string {
  const start = formatTime(startTime);
  if (!endTime) {
    return `${start} onwards`;
  }
  return `${start} - ${formatTime(endTime)}`;
}

const timeRange = getTimeRange(event.startTime, event.endTime);
const isTBC = event.venue === null || event.venue === "TBC" || event.venueTBC;
const hasCoordinates = isValidCoordinates(event.coordinates);

// Generate navigation URLs if coordinates exist
const googleMapsUrl = hasCoordinates && event.coordinates
  ? generateGoogleMapsUrl(event.coordinates, event.venue || undefined)
  : null;
const appleMapsUrl = hasCoordinates && event.coordinates
  ? generateAppleMapsUrl(event.coordinates, event.venue || undefined)
  : null;
---

<article class="event-card">
  <div class="event-header">
    <h4 class="event-name">{event.name}</h4>
    <Badge variant={event.type} size="sm">
      {event.type.replace("-", " ")}
    </Badge>
  </div>

  <p class="event-description">{event.description}</p>

  <div class="event-details">
    <div class="event-detail">
      <span class="detail-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </span>
      <span class="detail-text">{timeRange}</span>
    </div>

    <div class="event-detail">
      <span class="detail-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
      </span>
      {isTBC ? (
        <span class="detail-text detail-tbc">
          Venue To Be Confirmed
          <Badge variant="tbc" size="sm">TBC</Badge>
        </span>
      ) : (
        <span class="detail-text">{event.venue}</span>
      )}
    </div>

    {!isTBC && event.address && (
      <div class="event-detail event-address">
        <span class="detail-icon"></span>
        {googleMapsUrl ? (
          <a
            href={googleMapsUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="detail-text detail-secondary address-link"
            title="Click to get directions"
          >
            {event.address}
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="address-link-icon">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </a>
        ) : (
          <span class="detail-text detail-secondary">{event.address}</span>
        )}
      </div>
    )}

    {!isTBC && event.area && (
      <div class="event-detail event-area">
        <span class="detail-icon"></span>
        <span class="detail-text detail-muted">{event.area} area</span>
      </div>
    )}
  </div>

  {/* Mini-map and navigation section */}
  {!isTBC && showMap && hasCoordinates && event.coordinates && (
    <div class="event-map-section">
      <MiniMap
        latitude={event.coordinates.lat}
        longitude={event.coordinates.lng}
        venueName={event.venue || event.name}
        height="150px"
      />

      <div class="navigation-buttons">
        {googleMapsUrl && (
          <a
            href={googleMapsUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="nav-button nav-button-primary"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
            </svg>
            Get Directions
          </a>
        )}
        {appleMapsUrl && (
          <a
            href={appleMapsUrl}
            class="nav-button nav-button-secondary"
            title="Open in Apple Maps"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            Apple Maps
          </a>
        )}
      </div>
    </div>
  )}
</article>

<style>
  .event-card {
    background-color: white;
    border-radius: var(--radius-card);
    padding: var(--spacing-4);
    border-left: 4px solid var(--color-gold-500);
    box-shadow: var(--shadow-card);
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }

  .event-card:hover {
    box-shadow: var(--shadow-card-hover);
    transform: translateX(2px);
  }

  .event-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-2);
  }

  .event-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-earth-900);
    margin: 0;
  }

  .event-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-3);
  }

  .event-details {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
  }

  .event-detail {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .detail-icon {
    width: 16px;
    height: 16px;
    color: var(--color-earth-400);
    flex-shrink: 0;
  }

  .detail-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-primary);
  }

  .detail-secondary {
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
  }

  .detail-muted {
    color: var(--color-text-muted);
    font-size: var(--font-size-xs);
  }

  .detail-tbc {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    color: var(--color-earth-500);
    font-style: italic;
  }

  .event-address {
    margin-left: calc(16px + var(--spacing-2));
  }

  .event-area {
    margin-left: calc(16px + var(--spacing-2));
  }

  /* Clickable address link */
  .address-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-1);
    text-decoration: none;
    color: var(--color-text-secondary);
    transition: color 0.2s ease;
    cursor: pointer;
  }

  .address-link:hover {
    color: var(--color-gold-700);
    text-decoration: underline;
  }

  .address-link-icon {
    opacity: 0;
    transition: opacity 0.2s ease;
    flex-shrink: 0;
  }

  .address-link:hover .address-link-icon {
    opacity: 1;
  }

  /* Mini-map and navigation section */
  .event-map-section {
    margin-top: var(--spacing-4);
    padding-top: var(--spacing-4);
    border-top: 1px solid var(--color-border-light);
  }

  .navigation-buttons {
    display: flex;
    gap: var(--spacing-2);
    margin-top: var(--spacing-3);
    flex-wrap: wrap;
  }

  .nav-button {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: var(--radius-button);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .nav-button-primary {
    background-color: var(--color-gold-500);
    color: white;
  }

  .nav-button-primary:hover {
    background-color: var(--color-gold-600);
    transform: translateY(-1px);
  }

  .nav-button-secondary {
    background-color: var(--color-bg-secondary);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }

  .nav-button-secondary:hover {
    background-color: var(--color-earth-100);
    color: var(--color-earth-800);
    border-color: var(--color-earth-300);
  }

  .nav-button svg {
    flex-shrink: 0;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .event-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-2);
    }

    .navigation-buttons {
      flex-direction: column;
    }

    .nav-button {
      justify-content: center;
      width: 100%;
    }
  }
</style>
