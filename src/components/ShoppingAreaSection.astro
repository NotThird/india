---
/**
 * ShoppingAreaSection.astro
 *
 * Purpose: Display a shopping area with its description, tips, embedded map, and shop cards.
 *
 * Features:
 * - Area header with name and description
 * - Area-specific shopping tips
 * - Embedded mini-map showing all shops in the area
 * - Responsive grid of ShopCard components
 * - Collapsible tips section for mobile
 *
 * Props:
 * - area: ShoppingArea - Complete area information including shops
 * - showMap: boolean - Whether to show the embedded map (default: true)
 *
 * Dependencies: ShopCard.astro, MiniMap.astro
 */

import ShopCard from "./ShopCard.astro";
import type { ShoppingArea } from "../types/data";

interface Props {
  area: ShoppingArea;
  showMap?: boolean;
}

const { area, showMap = true } = Astro.props;

// Generate unique ID for the section
const sectionId = `area-${area.id}`;

// Serialize shop locations for the area map
const shopLocations = JSON.stringify(
  area.shops.map((shop) => ({
    lat: shop.coordinates.lat,
    lng: shop.coordinates.lng,
    name: shop.name,
    priceRange: shop.priceRange,
  }))
);

// Generate unique map ID
const mapId = `area-map-${area.id}-${Math.random().toString(36).substring(2, 9)}`;
---

<section id={sectionId} class="shopping-area-section">
  <!-- Area Header -->
  <div class="area-header">
    <div class="area-title-row">
      <h2 class="area-name">{area.name}</h2>
      <a href={`#${sectionId}`} class="anchor-link" title="Link to this section">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </a>
    </div>
    <p class="area-description">{area.description}</p>
  </div>

  <!-- Area Tips -->
  {area.tips.length > 0 && (
    <div class="area-tips">
      <details class="tips-details">
        <summary class="tips-summary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <span>Area Tips ({area.tips.length})</span>
          <svg
            class="chevron-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </summary>
        <ul class="tips-list">
          {area.tips.map((tip) => (
            <li>{tip}</li>
          ))}
        </ul>
      </details>
    </div>
  )}

  <!-- Area Content (Map + Shops) -->
  <div class="area-content">
    <!-- Embedded Map -->
    {showMap && area.shops.length > 0 && (
      <div class="area-map-container">
        <div class="map-header">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            <line x1="8" y1="2" x2="8" y2="18"></line>
            <line x1="16" y1="6" x2="16" y2="22"></line>
          </svg>
          <span>Shop Locations</span>
        </div>
        <div
          id={mapId}
          class="area-map"
          data-center-lat={area.coordinates.lat}
          data-center-lng={area.coordinates.lng}
          data-shops={shopLocations}
        >
        </div>
      </div>
    )}

    <!-- Shop Cards Grid -->
    <div class="shops-grid">
      {area.shops.map((shop) => (
        <ShopCard shop={shop} />
      ))}
    </div>
  </div>
</section>

<!-- Leaflet CSS and JS for area map -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  /**
   * Initialize area maps showing multiple shop markers
   */
  function initAreaMaps() {
    const areaMaps = document.querySelectorAll(".area-map");

    areaMaps.forEach((container) => {
      // Skip if already initialized
      if (container.hasAttribute("data-initialized")) return;

      const centerLat = parseFloat(container.getAttribute("data-center-lat") || "0");
      const centerLng = parseFloat(container.getAttribute("data-center-lng") || "0");
      const shopsStr = container.getAttribute("data-shops");

      if (!shopsStr || typeof L === "undefined") return;

      try {
        const shops = JSON.parse(shopsStr);
        const mapId = container.id;

        // Initialize map
        const map = L.map(mapId, {
          center: [centerLat, centerLng],
          zoom: 14,
          zoomControl: true,
          scrollWheelZoom: false,
        });

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
        }).addTo(map);

        // Create custom marker icon (green for shopping)
        const shopIcon = L.divIcon({
          className: "area-shop-marker",
          html: `
            <div class="shop-marker-pin" style="background-color: #22C55E;">
              <div class="shop-marker-inner"></div>
            </div>
          `,
          iconSize: [28, 36],
          iconAnchor: [14, 36],
          popupAnchor: [0, -36],
        });

        // Add markers for each shop
        const markers: L.Marker[] = [];
        shops.forEach((shop: { lat: number; lng: number; name: string; priceRange: string }) => {
          const marker = L.marker([shop.lat, shop.lng], { icon: shopIcon });
          marker.bindPopup(`
            <div style="text-align: center; min-width: 120px;">
              <strong>${shop.name}</strong><br/>
              <span style="font-size: 12px; color: #666;">${shop.priceRange.replace("-", " to ")}</span>
            </div>
          `);
          marker.addTo(map);
          markers.push(marker);
        });

        // Fit bounds to show all markers
        if (markers.length > 1) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }

        // Mark as initialized
        container.setAttribute("data-initialized", "true");
      } catch (e) {
        console.error("Failed to initialize area map:", e);
      }
    });
  }

  // Initialize maps when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(initAreaMaps, 200);
    });
  } else {
    setTimeout(initAreaMaps, 200);
  }

  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", () => {
    setTimeout(initAreaMaps, 200);
  });
</script>

<style>
  .shopping-area-section {
    margin-bottom: var(--spacing-12);
    scroll-margin-top: var(--spacing-20);
  }

  /* Area Header */
  .area-header {
    margin-bottom: var(--spacing-6);
  }

  .area-title-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-bottom: var(--spacing-2);
  }

  .area-name {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-earth-900);
    margin: 0;
  }

  .anchor-link {
    color: var(--color-earth-400);
    opacity: 0;
    transition: opacity 0.2s ease, color 0.2s ease;
  }

  .area-title-row:hover .anchor-link {
    opacity: 1;
  }

  .anchor-link:hover {
    color: var(--color-gold-600);
  }

  .area-description {
    color: var(--color-text-secondary);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    margin: 0;
  }

  /* Area Tips */
  .area-tips {
    margin-bottom: var(--spacing-6);
  }

  .tips-details {
    background-color: var(--color-cream-100);
    border-radius: var(--radius-card);
    overflow: hidden;
  }

  .tips-summary {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-4);
    cursor: pointer;
    font-weight: var(--font-weight-medium);
    color: var(--color-earth-800);
    list-style: none;
    transition: background-color 0.2s ease;
  }

  .tips-summary::-webkit-details-marker {
    display: none;
  }

  .tips-summary:hover {
    background-color: var(--color-cream-200);
  }

  .tips-summary svg:first-child {
    color: var(--color-gold-600);
  }

  .chevron-icon {
    margin-left: auto;
    color: var(--color-earth-500);
    transition: transform 0.2s ease;
  }

  .tips-details[open] .chevron-icon {
    transform: rotate(180deg);
  }

  .tips-list {
    padding: var(--spacing-2) var(--spacing-4) var(--spacing-4) var(--spacing-10);
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .tips-list li::marker {
    color: var(--color-gold-500);
  }

  /* Area Content */
  .area-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
  }

  /* Area Map */
  .area-map-container {
    background-color: white;
    border-radius: var(--radius-card);
    box-shadow: var(--shadow-card);
    overflow: hidden;
  }

  .map-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-4);
    background-color: var(--color-cream-100);
    border-bottom: 1px solid var(--color-border-light);
    font-weight: var(--font-weight-medium);
    color: var(--color-earth-700);
    font-size: var(--font-size-sm);
  }

  .map-header svg {
    color: var(--color-orange-500);
  }

  .area-map {
    height: 250px;
    width: 100%;
  }

  /* Shop Marker Styles */
  :global(.area-shop-marker) {
    background: transparent !important;
    border: none !important;
  }

  :global(.shop-marker-pin) {
    width: 28px;
    height: 28px;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }

  :global(.shop-marker-inner) {
    width: 12px;
    height: 12px;
    background-color: white;
    border-radius: 50%;
    transform: rotate(45deg);
  }

  /* Shops Grid */
  .shops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: var(--spacing-6);
  }

  /* Responsive */
  @media (max-width: 767px) {
    .area-name {
      font-size: var(--font-size-xl);
    }

    .anchor-link {
      opacity: 1;
    }

    .area-map {
      height: 200px;
    }

    .shops-grid {
      grid-template-columns: 1fr;
    }

    .tips-details[open] {
      /* Auto-open on mobile */
    }
  }
</style>
